:toc2:
:icons: images/icons

== Creating Applications Lab

This lab includes the following sections:

* *Deploy Application on Web Console*
+
In this section, you deploy an application from a code repository and follow the build logs on the OpenShift Enterprise web console and CLI.

* *Customize Build Script*

- Create an application from a forked Git repository, inject a custom build script, and start a rebuild from the web console.

- Review your custom script messages in the logs.

:numbered:

== Deploy Application on Web Console

Here, you connect to and become familiar with the web console, create a project and an application, and scale a deployment and the topology view.

=== Connect To and Explore Web Console

. Use your browser to go to the OpenShift web console at `https://master1-GUID.oslab.opentlc.com:8443`.
+
NOTE: If you have not done so already, accept the untrusted certificate.

. Log in as `andrew` with the password `r3dh4t1!`.

. Take a few minutes to browse your projects.

=== Create New Project

. Click *Projects* and select *View all projects* to return to the Projects view.

. Click the blue *New Project* button in the top right corner.

. Give the new project a name, display name, and description:
* *Name*: `my-ruby-project`
* *Display Name*: `My Ruby Example Project`
* *Description*: An explanation of your choice

Once the project is in place, the *Select Image or Template* screen is displayed.

=== Create New Application

. In the *Select Image or Template* screen, type `ruby` in the search field to filter the available instant apps, templates, and builder images.

. Select the `ruby:2.0` builder image on the right.

. Specify the name and Git repository URL:
* *Name*: `my-ruby-hello-world`.
* *Git Repository URL*: `https://github.com/openshift/ruby-hello-world`.

. Click *Show advanced build and deployment options* and select the following options:
.. Decide if you want a route for your application.
.. Optionally, define the triggers and environment variables for the deployment.
.. Change the scaling parameter to 3.
.. Create a label for `environment` by typing `dev`.

. Accept and start the application.

. Review the information that is displayed.

. Click *Continue to Overview* to go to the application's *Overview* screen.

. Click *View Logs* to verify that a build is in progress.

. Review the log as the build progresses.

. Wait for the build to complete and use a browser to navigate to the
 application route: link:http://my-ruby-hello-world-my-ruby-project.cloudapps-GUID.oslab.opentlc.com[http://my-ruby-hello-world-my-ruby-project.cloudapps-GUID.oslab.opentlc.com]
.. The database for our application isn't running, so expect to see the web
 page mention that.
+
[TIP]
====
* You can also use the command line to create a new application: `oc new-app https://github.com/openshift/ruby-hello-world -l  environment=dev`.

* To change scaling from the command line, use `oc scale`.
====

=== Scale Deployment and Topology View

. Go back to your application's *Overview* screen by clicking *Overview* at the upper left side.

. Observe the circle that shows the current number of pods, which is 1. You can increase that number by clicking the `^` button next to it.

image::images/ose_lab6_image1.png[]

. Click the `^` button twice to increase the number of replicas to 3.

. Hover over *Browse* and select *Pods* to take a look at your new pods.

. Go back to your application's *Overview* screen by clicking *Overview* again.

* The current and default view of the *Overview* screen is the *Tile View*.
* To switch to the *Topology View*, click the button on the upper right hand side that looks like the *`<`* character or a social-media Share button, which it is not.

image::images/ose_lab6_image2.png[]

. Click the objects and consider their relationships.


== Customize Build Script

OpenShift Enterprise 3 supports customization of both the build and run processes. Generally speaking, this involves modifying the S2I scripts from the builder image. While building your code, OpenShift Enterprise checks the scripts in your repository's `.sti/bin` folder to see if they override or supersede the builder image's scripts. If it finds scripts that do so, it executes those scripts.

For details on the scripts and their execution and customization, go to `https://docs.openshift.com/enterprise/3.1/creating_images`.


=== Clone Repository and Launch Application from Local Copy

. Log in to OpenShift Enterprise as `marina`:
.. Connect to the OpenShift Enterprise master by following the same steps as before.
.. When prompted, type the username and password:
** *Username*: `marina`
** *Password*: `r3dh4t1!`
+
----
[root@master1 ~]# su - marina
[marina@master1 ~]$ oc login -u marina --insecure-skip-tls-verify --server=https://master1-${guid}.oslab.opentlc.com:8443

[marina@master1 ~]$ oc new-project custom-s2i-script --display-name="Custom S2I Build Script" \
    --description="This is the project we use to learn how to create a customized build script"
----

=== Fork Repository

IMPORTANT: This section requires a GitHub account. Create one if you do not have one already. It is free and useful.

. From the GitHub web UI, fork the `https://github.com/openshift/ruby-hello-world` Git repository into your own Git account by clicking *Fork* in the upper right corner.

* This creates a repository in your Git account with a name similar to `https://github.com/yourname/ruby-hello-world/`, where _yourname_ is your Git username.

. Clone this `https://github.com/yourname/ruby-hello-world` repository so that you can edit it locally and test a Red Hat-customized script with it:
+
CAUTION: Be sure to replace _yourname_ with your Git username.
+
----
[marina@master1 ~]$ git clone https://github.com/yourname/ruby-hello-world
Cloning into 'ruby-hello-world'...
remote: Counting objects: 249, done.
remote: Total 249 (delta 0), reused 0 (delta 0), pack-reused 249
Receiving objects: 100% (249/249), 36.79 KiB | 0 bytes/s, done.
Resolving deltas: 100% (86/86), done.
----

. Create an application by running `oc new-app` in the local repository:
+
----
[marina@master1 ~]$ cd ruby-hello-world/
[marina@master1 ruby-hello-world]$ oc new-app . --docker-image=registry.access.redhat.com/openshift3/ruby-20-rhel7
----

. View the current build status and build logs:
+
----
[marina@master1]$ oc get builds
NAME                 TYPE      FROM         STATUS    STARTED         DURATION
ruby-hello-world-1   Docker    Git@master   Running   9 seconds ago   9s
----

. View the build log:
+
----
[marina@master1 ]$ oc logs -f builds/ruby-hello-world-1
...                 ...
... Omitted Output  ...
...                 ...
Removing intermediate container 049a12eb5ca5
Successfully built 995028e8bee2
I1127 02:41:37.640510       1 docker.go:86] Pushing image 172.30.42.118:5000/custom-s2i-script/ruby-hello-world:latest ...
I1127 02:44:25.867627       1 docker.go:90] Push successful
----

. Verify that your pod has deployed:
+
----
[marina@master1 ]$ oc get pods
NAME                       READY     STATUS      RESTARTS   AGE
ruby-hello-world-1-70mlb   1/1       Running     0          12s
ruby-hello-world-1-build   0/1       Completed   0          9m
----


=== Add Script to Repository

. Open a new tab in your browser, go to `http://www.opentlc.com/download/ose_implementation/resources/3.1/assemble`, and copy all of the text there.

. Go to your GitHub repository for your application from the previous section.

. In the GitHub web UI, navigate to the `.sti/bin` folder.

. Click the *New File* button at the top right (to the right of `bin` in the breadcrumb).

. Name your file `assemble`.

. In the GitHub web UI, paste the content you copied earlier into the text area.

. Type a commit message in the text field.

. Click *Commit*.


=== Create Application From Repository With Custom Build Script

. From your browser, go to the OpenShift web console at `https://master1-GUID.oslab.opentlc.com:8443`.
+
NOTE: If prompted, accept the untrusted certificate.

. Log in as `marina` with the password `r3dh4t1!`.

. Click the blue *New Project* button in the top right corner.

. Specify the project name, display name, and description:
* *Name*: `my-custom`
* *Display Name*: `My custom assemble script project`
* *Description*: An explanation of your choice

** Once the project is in place, the *Select Image or Template* screen is displayed.

. In the *Select Image or Template* screen, type `ruby` in the search field to filter the available Instant Apps, Templates, and Builder Images.

. Select the `ruby:2.0` builder image from the right hand side.

. Specify the name and Git repository URL:
* *Name*: `my-custom-builder-test`
* *Git Repository URL*: `https://github.com/yourname/ruby-hello-world`
+
CAUTION: Remember to replace _yourname_ with your Git username in the above command.

. Follow the build process logs and watch for this custom assemble script message, which confirms that the custom script ran:
+
----
2015-04-27T22:23:24.110630393Z ---> CUSTOM S2I ASSEMBLE COMPLETE
----
