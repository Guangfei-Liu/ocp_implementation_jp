:toc2:
:icons: images/icons

== Templates Lab

This lab includes the following sections:

* *Create and Upload Template*
+
In this section, you create a template for a two-tier application (front end and database), upload it into the shared namespace (the `openshift` project), and ensure that users can deploy it from the web console.

* *Use Templates and Template Parameters*
+
In this section, you create two separate template instances in two separate projects and establish a front-end-to-database-back-end connection by means of template parameters.

:numbered:

== Create and Upload Template

=== Install Template

The example in this section involves a build of an application and a service with two pods: a front-end web tier and a back-end database tier. This application uses auto-generated parameters and other sleek features of OpenShift Enterprise.  Note that this application contains predefined connectivity between the front-end and back-end components as part of its JSON, embedded in the source code.  You add resources in a later lab.

This example is, in effect, a "quick start" -- a predefined application that comes in a template and that you can immediately use or customize.

. As `root` on the master host, download the template's definition file:
+
----
[root@master00-GUID ~]# wget http://www.opentlc.com/download/ose_implementation/3.1/resources/Template_Example.json
----

. Create the template object in the shared `openshift` project. This is also referred to as _uploading_ the template.
+
----
[root@master00-GUID ~]# oc create -f Template_Example.json -n openshift
template "a-quickstart-keyvalue-application" created
----
NOTE: The `Template_Example.json` file defines a template. By "creating" it, you added it to the `openshift` project. To make the template available only for limited projects, add it to them, not to the `openshift` project.

=== Create Instance of Template

. On your browser, connect to the OpenShift web console at `https://master00-GUID.oslab.opentlc.com:8443`:
.. If prompted, accept the untrusted certificate.
.. Log in as `andrew` with the password `r3dh4t1!`.

. Click the blue *New Project* button in the top right corner.

. Specify the project name, display name, and description:
* *Name*: `instant-app`
* *Display Name*: `instant app example project`
* *Description*: `A demonstration of an instant app or template`.
+
[TIP]
====
Alternatively, perform this step from the command line:

----
[root@master00-GUID ~]$ oadm new-project instant-app --display-name="instant app example project" \
    --description='A demonstration of an instant-app/template' \
    --node-selector='region=primary' --admin=andrew
----
====

. From the `instant-app` project's *Overview* screen, click *Add to project*.
+
[NOTE]
This familiar screen now displays something new: an instant application, a special kind of template with the `instant-app` tag. The idea behind an instant application is that, when you create a template instance, you already have a fully functional application. In this example, your instant application is just a simple web page for key-value storage and retrieval.

. Click *a-quickstart-keyvalue-application*.
+
The template configuration screen is displayed. Here, you can specify certain options for instantiating the application components:
+
.. Set the `ADMIN_PASSWORD` parameter to your favorite password.
.. Add a label named `version` with the value `1`.

. Click *Create* to instantiate the services, pods, replication controllers, etc.

* The build starts immediately. 
. Wait for the build to finish. You can browse the build logs to follow the progress.

=== Use Application

After the build is complete, visit your application at `http://example-route-instant-app.cloudapps-GUID.oslab.opentlc.com/`.

[NOTE]
Be sure to use HTTP and _not_ HTTPS. HTTPS does not work for this example because the form submission was coded with HTTP links.

== Use Templates and Template Parameters

Quick starts are slick. But there are times when developers want to build the components manually. Here, you treat the quick-start example as two separate applications to be wired together.

=== Deploy Ephemeral Database Back End

. Create a project for the database back end:

.. Use your browser to connect to the OpenShift web console at `https://master00-GUID.oslab.opentlc.com:8443`.
.. If prompted, accept the untrusted certificate.
.. Log in as `marina` with the password `r3dh4t1!`.

.. Click the blue *New Project* button in the top right corner.

.. Specify the project name, display name, and description:
* *Name*: `templates`
* *Display Name*: `Templates Testing Project`
* *Description*: `Project for testing templates`
[TIP]
Alternatively, perform this step from the command line:
+
----
[root@master00-GUID ~]$ oadm new-project templates --display-name="Templates Testing Project" \
    --description='Project used to test templates' \
    --admin=marina
----

. Deploy an ephemeral MySQL database:

.. From the `database-backend` project's *Overview* screen, click *Add to project*.
.. Scroll down to *Databases* or type `mysql` in the search field.
.. Select the `mysql-ephemeral` database template.

.. Set the template parameters:
* *`DATABASE_SERVICE_NAME`*: `database`
* *`MYSQL_USER`*: `root`
* *`MYSQL_PASSWORD`*: `redhat`
* *`MYSQL_DATABASE`*: `mydb`

.. Click *Create* and then click *Continue to overview*.
+
[TIP]
Alternatively, create the template instance from the command line:
+
----
oc new-app --template=mysql-ephemeral --param=MYSQL_USER=root,MYSQL_PASSWORD=redhat,MYSQL_DATABASE=mydb,DATABASE_SERVICE_NAME=database
----

.. As `marina`, examine the objects that were created as part of the `mysql-ephemeral` template:
+
----
[marina@master00-GUID ~]$ oc get projects
NAME                DISPLAY NAME                STATUS
custom-s2i-script   Custom S2I Build Script     Active
templates           Templates Testing Project   Active

[marina@master00-GUID ~]$ oc get dc
NAME       TRIGGERS                    LATEST
database   ConfigChange, ImageChange   1

[marina@master00-GUID ~]$ oc get service
NAME       CLUSTER_IP       EXTERNAL_IP   PORT(S)    SELECTOR        AGE
database   172.30.213.227   <none>        3306/TCP   name=database   38s
----
+
[NOTE]
A deployment configuration is available for your instance. The service name is the same as that of your `DATABASE_SERVICE_NAME` parameter.

.. Verify that the values of the environment variables in the deployment configuration (`dc`) are correct:
+
----
[marina@master00-GUID ~]$ oc env dc database --list
# deploymentconfigs mydb-service, container mysql
MYSQL_USER=root
MYSQL_PASSWORD=redhat
MYSQL_DATABASE=mydb
----

=== Deploy Application's Ruby Front End

. As `marina`, create an application with the `https://github.com/openshift/ruby-hello-world` Git repository:
+
----
[marina@master00-GUID ~]$ oc new-app -i openshift/ruby https://github.com/openshift/ruby-hello-world \
                          --param=MYSQL_USER=root,MYSQL_PASSWORD=redhat,MYSQL_DATABASE=mydb
----

. Verify that your service is in place:
+
----
[marina@master00-GUID ~]$ oc get service
NAME               CLUSTER_IP       EXTERNAL_IP   PORT(S)    SELECTOR                                                 AGE
database           172.30.213.227   <none>        3306/TCP   name=database                                            2m
ruby-hello-world   172.30.46.194    <none>        8080/TCP   app=ruby-hello-world,deploymentconfig=ruby-hello-world   14s
----

. Create an external route to your front-end application.
 
* If you do not specify a host name, the default subdomain route creates the route.
+
----
[marina@master00-GUID ~]$ oc expose service ruby-hello-world
route "ruby-hello-world" exposed

[marina@master00-GUID ~]$ oc get route
NAME               HOST/PORT                                                     PATH      SERVICE            LABELS
ruby-hello-world   ruby-hello-world-templates.cloudapps-GUID.oslab.opentlc.com             ruby-hello-world   app=ruby-hello-world
----

. Wait for the build to complete. Then test your environment:
+
----
[marina@master00-GUID ~]$ oc logs -f builds/ruby-hello-world-1
... Omitted Output ...
I1127 09:15:14.147821       1 cleanup.go:23] Removing temporary directory /tmp/s2i-build846159358
I1127 09:15:14.148009       1 fs.go:99] Removing directory '/tmp/s2i-build846159358'
I1127 09:15:14.173869       1 sti.go:213] Using provided push secret for pushing 172.30.42.118:5000/templates/ruby-hello-world:latest image
I1127 09:15:14.173963       1 sti.go:217] Pushing 172.30.42.118:5000/templates/ruby-hello-world:latest image ...
I1127 09:23:36.705738       1 sti.go:233] Successfully pushed 172.30.42.118:5000/templates/ruby-hello-world:latest
----

. Wait for the pods to start and verify that your application is running and connecting to the database:
+
----
http://ruby-hello-world-templates.cloudapps-c0fe.oslab.opentlc.com
----
